# 도커 컴포즈를 이용한 환경 구성

## 이식성

계속해서 얘기 되었지만 도커의 가장 핵심적인 장점은 이식성입니다.<br/>
이는 도커가 동일한 환경을 제공하여, 어떠한 환경에 배포해도 애플리케이션이 동일하게 동작하도록 보장합니다.<br/>
<br/>
도커는 애플리케이션과 그에 필요한 모든 의존성을 컨테이너 안에 패키징하므로, 컨테이너가 실행되는 환경에 상관없이 애플리케이션은 항상 동일하게 동작합니다.<br/>
이는 개발, 테스트, 프로덕션 등 다양한 환경에서 일관된 동작을 보장하므로, 환경 설정에 따른 버그를 최소화하고 배포 과정을 단순화하는 데 도움이 됩니다.
<br/><br/>

**_환경에 따라 애플리케이션의 동작을 달리해야 하는 경우_**
도커 컴포즈를 사용하여 해결할 수 있습니다.

## 여러 개의 애플리케이션 배포하기

### 도커 컴포즈

도커 컴포즈는 여러 개의 컨테이너로 구성된 애플리케이션을 단일 도커 엔진 호스트에서 실행하기 위한 도구입니다.<br/>
주로 개발 환경에서 사용되며, 환경이 다를 때 유용하게 사용할 수 있습니다.<br/><br/>
서로 다른 디렉토리에 있는 컴포즈 파일로 애플리케이션을 실행할 수 있으며, 동일 디렉토리에서는 불가능합니다. 이는 프로젝트명의 기본 값이 폴더명이기 때문입니다. 동일 디렉토리에서 실행하려면 프로젝트 이름을 변경해야 합니다. 이를 통해 컨테이너 번호를 포스트픽스로 붙여 구분할 수 있습니다.

> 만약 동일한 컨테이너를 프로젝트 이름을 바꿔서 실행하면 무작위 포트를 개방하여 포트를 따로 알아야합니다.

```
docker-compose -f {yml 경로} -p {project-name} up -d
docker container port {project-name} 80
```

하지만 위의 명령으로 실행하면 포트가 무작위로 배정되기 때문에 실행중인 컨테이너에 접근해 직접 포트를 일일이 찾아야합니다.

## 도커 컴포즈의 오버라이드 파일

하나의 컨테이너를 여러 설정으로 실행해야 하는 경우, 컴포즈 파일을 여러 개 두는 것은 유지보수에 좋지 않습니다. 도커 컴포즈는 여러 파일을 합쳐 하나의 컴포즈 파일로 구성할 수 있으며, 나중에 지정된 파일이 이전 파일을 오버라이드합니다.<br/>
<br/>
이를 이용해 `[그림 10-4]`처럼 컴포즈 파일을 작성하여 환경별에 적용할 컴포즈를 정의.<br/>
<br/>
이를 통해 환경별로 다른 설정을 적용할 수 있습니다. 오버라이드 파일에는 변경할 항목만 기술하면 되며, 기존 구조를 유지해야 두 정의를 연결 지을 수 있습니다.<br/>
(`[예제 10-1]` 참조)<br/>
<br/>

```
docker-compose -f {선병합 yml 경로} -f {후병합 yml 경로} config
```

config를 사용하면 도커 컴포즈는 인자로 받은 순서대로 오버라이드 yml을 병합하며,<br/>한 서버에서 여러 개의 애플리케이션을 실행할 수 있으며, 도커 네트워크를 통해 서로 독립적으로 운영할 수 있습니다.

### 도커 컴포즈는 클라이언트에서 동작한다.

애플리케이션 관리를 하려면 컴포즈 파일에 접근이 가능해야하며, 프로젝트 이름을 알고 있어야 합니다.

```
-f = file, -p = project
```

오버라이드를 사용하면 몇 벌이든 같은 애플리케이션을 실행할 수 있지만 관리에 오버헤드도 발생합니다. 따라서 배포 및 폐기의 자동화를 생각해야 합니다.

## 환경 변수와 비밀값을 이용해 설정 주입하기

- 런타임에 컨테이너 안에서 비밀값을 가져올 수 있습니다.
  - 오버라이드
  - 호스트 컴퓨터의 환경 변수
    - 디렉토리에 .env가 있으면 별도의 오버라이드 파일 없이 우선적으로 가져옵니다.

## 확장 필드로 중복 제거하기

도커 컴포즈 파일은 서비스 간 많은 설정값을 공유하면서 크기가 커질 수 있습니다. 확장 필드를 통해 YAML의 여러 블록을 한곳에 정의하고, 스크립트 전체에 걸쳐 이 블록을 재사용할 수 있습니다.

## 도커를 이용한 설정 워크플로 이해하기

> git을 통해 도커 설정 워크플로를 관리하는 것이 유리합니다.

- 애플리케이션 구성 요소의 조합
- 컨테이너 설정
- 애플리케이션 설정
