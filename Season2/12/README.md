12장 컨테이너 오케스트레이션 : 도커 스웜과 쿠버네티스

# 💡 오케스트레이션 도구란?

<aside>
💡 대규모 트래픽을 처리하고 고가용성을 확보하기 위해 여러 대의 도커 호스트로 구성된 애플리케이션을 실행해야 합니다. 이를 위해 여러 대의 도커 호스트와 컨테이너를 관리하는 **관리 레이어**가 추가됩니다. 이 레이어를 오케스트레이션이라고 합니다.

</aside>

오케스트레이션 도구는 클러스터를 구성하는 여러 대의 호스트 컴퓨터를 관리하는 역할을 합니다.

## 오케스트레이션 도구의 역할

- 컨테이너 관리
- 트래픽 분산
- 작업 분배
- 불량 컨테이너 교체

즉, 총체적인 컨테이너 관리 역할을 합니다. YAML 파일에 원하는 애플리케이션의 상태를 작성하여 클러스터 API로 전달하면 그 내용에 맞추어 컨테이너를 실행하고 관리합니다.

클러스터 내의 컨테이너는 DNS와 표준 네트워크 프로토콜을 통해 자유롭게 통신할 수 있습니다. 클러스터는 공유 스토리지를 제공하여, 서로 다른 서버에서 실행된 컨테이너도 상태를 공유할 수 있습니다. 오케스트레이션 계층은 컨테이너로의 트래픽 라우팅도 담당합니다.

# 🐳 도커 스웜

도커 스웜에서는 클러스터에 속한 컴퓨터가 매니저와 워커라는 두 가지 역할 중 하나를 맡습니다.

- **매니저**: 클러스터를 관리하는 작업을 수행합니다.
  - 클러스터 데이터베이스는 매니저 노드에 저장됩니다.
  - YAML 파일 전달을 위한 API도 매니저 노드에서 동작합니다.
  - 컨테이너 모니터링과 스케줄링 모두 매니저 노드의 담당입니다.
- **워커**: 스케줄링에 따라 컨테이너를 실행하고, 상태를 매니저에게 보고하는 역할을 합니다.

# 👩‍💻 도커 스웜 서비스로 애플리케이션 실행하기

서비스는 컨테이너를 추상화한 개념입니다. 하나의 서비스가 여러 개의 컨테이너로 배포될 수 있다는 점에서 스웜에서 말하는 서비스는 도커 컴포즈에서 말하는 서비스와 유사합니다.

- **도커 스웜 레플리카**: 서비스를 구성하는 컨테이너를 레플리카라고 부릅니다. 도커 스웜은 레플리카의 수를 지정하고, 설정된 수 만큼 클러스터에 존재해야 합니다.
- 도커 컴포즈와 도커 스웜의 가장 큰 차이점은 도커 컴포즈는 애플리케이션 정의를 저장할 공간이 없다는 것입니다.

## 🔄 롤링 업데이트

모든 컨테이너 오케스트레이션 도구는 애플리케이션을 중단시키지 않고 점진적으로 컨테이너를 교체하는 롤링 업데이트 방식을 사용합니다.

- 롤링 업데이트의 설정은 변경 가능합니다.
- 새로운 버전에 문제가 있으면 업데이트를 중단할 수 있습니다.
- 스웜의 데이터베이스에 이전 버전의 서비스 정의가 남아있어 이전 버전으로 롤백이 가능합니다.

```
docker service update --rollback timecheck
```

스웜 모드에서는 컨테이너보다 서비스를 다룹니다. 또한, 스웜 모드의 컨테이너는 도커 네트워크를 통해 통신하며 외부 트래픽은 공개된 포트를 통해서만 전달됩니다.

# 🌐 클러스터 환경에서 네트워크 트래픽 관리

스웜 모드에서는 서로 다른 노드에서 실행 중인 컨테이너 간에 요청과 응답을 주고받을 수 있습니다.

## 오버레이 네트워크

<aside>
💡 오버레이 네트워크는 클러스터에 속한 모든 노드를 연결하는 가상 네트워크입니다. 스웜의 네트워크는 클러스터 전체를 연결하면서도 애플리케이션에는 서로 독립적인 환경을 제공합니다.

</aside>

- 도커 네트워크는 독립적이기 때문에 같은 네트워크에 연결된 서비스에 속한 컨테이너끼리만 서로 통신할 수 있습니다.
- 도커 컴포즈로 실행된 여러 개의 컨테이너는 각각의 IP 주소가 응답되지만, 스웜의 서비스는 여러 개의 컨테이너를 실행하여도 하나의 IP 주소만 조회됩니다. 이 주소는 가상 IP(VIP) 주소로 모든 레플리카가 공유합니다.
- VIP 네트워크 방식으로 인해 오버레이 네트워크는 애플리케이션 관점에서는 겉으로 드러나지 않습니다.
- **오버레이 네트워크말고 다른 네트워크를 사용할 수 있다.(옵션)**

## 스웜의 인그레스 네트워킹

서비스가 포트를 공개하면 모든 노드가 해당 포트를 감시하고 트래픽을 받습니다. 만약 노드가 요청을 처리하지 못하면 다른 노드로 요청을 포워딩합니다.

- 도커 컴포즈는 여러 컨테이너가 같은 포트를 감시할 수 없기 때문에 이 방법을 사용할 수 없습니다.
- 노드 내에서의 트래픽 로드밸런싱은 도커가 맡습니다.

윈도우 운영체제에서는 localhost로 스웜 서비스에 접근할 수 없습니다.

# 🆚 도커 스웜과 쿠버네티스

도커 스웜은 쿠버네티스에 비해 확장성이 부족하고, 클라우드에서 운영하기 위해서는 가상 머신의 관리와 스웜 초기화를 직접해야 합니다. (자동화는 가능함)

**Action Item**

- 매니저와 워커의 그룹핑 방식
- 인그레스란?
