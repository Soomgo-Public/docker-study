# 13장 도커 스웜 스택으로 분산 애플리케이션 배포하기

## 1. 도커 컴포즈를 사용한 운영 환경

별도의 추가설정 없이 컴포즈 파일만으로 스웜에 애플리케이션을 배포할 수 있다.

- 도커 컴포즈 문법을 사용해 애플리케이션 구성요소를 정의하여 매니저 노드에 YAML파일을 전달하면 네트워크나 서비스를 정의된대로 만들어준다.
- 레플리카 하나를 실행 중인 서비스가 생성되고 이 서비스는 인그레스 네트워크(스웜 클러스터를 생성하면 자동으로 생성되는 네트워크)를 통해 포트를 공개한다.
- 애플리케이션을 배포할 때 `스택`을 만든다.

  ```
  💡 스택
  - 서비스, 네트워크, 볼륨 등 여러개의 리소스를 묶어 만든 리소스. 스웜의 일급 리소스.
  - 스웜 스택에 업데이트를 적용하기 위해서는 YAML파일 수정해서 매니저 노드에 전달하면 그대로 애플리케이션에 반영된다.
  - 애플리케이션을 그룹화하는 방법으로 활용할 수 있다. stack 명령을 사용해 여러 애플리케이션을 하나의 대상으로 다룬다. 각 서비스나 서비스의 레플리카 목록을 보거나 전체를 한꺼번에 제거할 수 있다.
  ```

- 컴포즈 파일에 deploy 항목을 추가해 레플리카 개수를 여러 개로 늘리고 한 레플리카의 계산 자원의 사용량을 제한하도록 설정할 수 있다.(예제 13-2)

<br/>

## 2. 컨피그 객체를 이용한 설정값 관리

- 컨피그(config) 객체: 컨테이너가 설정값을 클러스터에서 읽어올 수 있도록 해주는 리소스
- 애플리케이션 배포와 설정관리를 분리해준다.(컨피그 객체를 먼저 배포하고 애플리케이션을 배포)
- 기존 설정 파일에서 컨피그 객체를 생성해 클러스터에 로드한다.(예제 13-3)
- 컨피그 객체는 보안이 적용되지 않는다. 클러스터 접근권한이 있다면 누구든 객체의 내용을 모두 알 수 있다.(그림 13-6)

<br/>

## 3. 비밀값을 이용한 대외비 설정 정보 관리하기

- 비밀값은 컨피그 객체와 비슷한 점이 많다.
  - 로컬 파일로 생성한 후 클러스터 DB에 저장했다가 서비스정의에서 참조된 비밀값이 파일시스템에 의해 전달된다.(예제 13-4)
  - 매니저 노드에 위치한 분산형 DB에 저장돼 필요로 하는 노드에서 모두 사용할 수 있다.
  - 수정이 불가능하다. 변경해야한다면 새롭게 생성해서 서비스 정의에서 새로 만든 이름으로 바꾸고 스택을 배포해야한다.(이는 쿠버네티스와 다르다.)
- 비밀값이 컨테이너에 전달된 상태에서만 복호화된 비밀값을 볼 수 있다.(그림 13-8)

<br/>

## 4. 스웜에서 볼륨 사용하기

- 볼륨: 컨테이너와 별개의 생애주기를 갖는 스토리지의 단위. 컨테이너 외부에 존재하는 리소스.
- 애플리케이션 업데이트 → 컨테이너 교체 → 볼륨과 새 컨테이너 연결 → 이전 컨테이너가 갖던 데이터 유지
- 컴포즈 파일의 서비스 정의에 볼륨 마운트를 정의하면 레플리카에서 볼륨을 로컬 파일 시스템의 디렉토리처럼 사용할 수 있다.
- 클러스터는 여러 개의 노드로 구성되고, 노드는 각각 디스크가 있다. 이 디스크에 볼륨을 저장한다.(로컬 볼륨)
  - 👿 어떤 레플리카를 대체하는 새로운 레플리카가 이전 레플리카와 다른 노드에서 실행된다면?
    - 새 레플리카는 기존 레플리카의 로컬 볼륨에 접근할 수 없다.
    - 😇 노드에 레이블을 부여하고 컴포즈 파일에서 해당 노드에서만 레플리카를 실행하도록 강제할 수 있다. (예제 13-5)
      (단, 레플리카를 여러개 실행하지 않고 서버 고장도 일어나지 않아야한다)
- dockerfile 스크립트에서 볼륨이 지정된 이미지를 사용하면 이 스택에는 기본 볼륨이 만들어진다.(그림 13-11)
- 스택 업데이트 후 데이터 유지를 위해서는 이름을 부여한 볼륨을 사용해야한다.
  - 이름이 붙은 볼륨은 스택을 제거해도 레이블이 붙은 노드가 남아있으면 데이터가 유지된다.
- 로컬 볼륨은 여러 노드에 걸쳐 상태를 공유해야하는 애플리케이션에서는 사용할 수 없다.

<br/>

## 5. 클러스터는 스택을 어떻게 관리하는가?

- 스택: 클러스터가 관리를 담당하는 리소스의 모임(그림 13-13)
- 스택에는 서비스 간의 의존 관계를 정의하는 기능이 없다. 애플리케이션이 무작위로 실행되고 정상적으로 실행할 수 없는 경우에는 컨테이너를 조기에 종료시킨다. 컨테이너 재시작, 대체로 문제를 해결한다. (자기 수복 가능 애플리케이션)
